console.log("chat_engine.js file is loaded");class ChatEngine{constructor(e,t,s,o){console.log(s,"userId"),this.chatBox=$("#"+e),this.userEmail=t,this.userName=o,this.userId=s,this.socket=io.connect("http://localhost:5000"),this.userEmail&&this.connectionHandler()}connectionHandler(){let e=this;this.socket.on("connect",(function(){console.log("connection established using sockets...!",e.userId),e.socket.emit("loggedin",e.userId),$("#user-chat-box").hide()})),e.socket.on("invite",(function(t){console.log("Invitation received to join a room"),console.log("Invition accepted to join the room"),e.socket.emit("joinRoom",t),$(`span[data-room="${t.room.room}"]`).attr("data-room-created","true")})),$("#chat-message-input-container").submit((function(t){t.preventDefault();let s=$("#chat-message-input").val();console.log("After mgs is clicked: ");let o=$("#chat-message-input-container button").attr("data-room");""!=s&&"null"!=o&&($.ajax({type:"post",url:"/chats/create",data:$("#chat-message-input-container").serialize(),success:function(e){console.log("message sent "+e),new Noty({theme:"relax",text:"Message Sent!",type:"success",layout:"topRight",timeout:1500}).show()},error:function(e){console.log(e.responseText)}}),e.socket.emit("send_message",{message:s,user_email:e.userEmail,user_name:e.userName,user_id:e.userId,room:o}),$("#chat-message-input").val(""))})),e.socket.on("receive_message",(function(t){console.log("message received",t.message),$("#user-chat-box").show();let s=$("#chat-message-input-container button").attr("data-room");if("null"==s||s==t.room){let s=$("<li>"),o="other-message";t.user_email==e.userEmail&&(o="self-message"),s.append($("<span>",{html:t.message})),s.append($("<sub>",{html:t.user_email})),s.addClass(o),$("#chat-messages-list").append(s),$("#chat-message-input-container button").attr("data-room",t.room),$("#chat-with-friend").val(t.user_id),e.userName!=t.user_name&&$("#chat-box-friend-name").html(t.user_name)}else{$(`span[data-room="${t.room}"]`).append("<b> &ensp; mgs </b>")}}))}createRoom(e,t){console.log("createRoom function is called with friendId",e);let s=$(`#chat-${e} span`).attr("data-room-created");console.log("isRoomExist value: ",s,$(`#chat-${e} span`));let o=$(`#chat-${e} span`).attr("data-room");"false"==s?(console.log("Room created successfully by you, room is: ",o),this.socket.emit("create",{room:o,userId:this.userId,withUserId:e}),$(`#chat-${e} span`).attr("data-room-created","true"),this.openChatWindow(o,e,t)):(console.log("Room already exists"),this.openChatWindow(o,e,t))}openChatWindow(e,t,s){$("#chat-messages-list").html(""),$("#user-chat-box").show(),$("#chat-message-input-container button").attr("data-room",e),$("#chat-with-friend").val(t),$("#chat-box-friend-name").html(s),console.log("New chat window opened"),this.fillChats(t)}fillChats(e){let t=this;$.ajax({type:"get",url:"/chats",data:{friendId:e},success:function(e){console.log("message received "+e);for(let s of e.data.chats){let e=$("<li>"),o="other-message";console.log("chat.from_user._id",s.from_user._id),console.log("xyxyyxyxyxy",t.userId),s.from_user._id==t.userId&&(o="self-message"),e.append($("<span>",{html:s.message})),e.append($("<sub>",{html:"sender email"})),e.addClass(o),$("#chat-messages-list").append(e)}},error:function(e){console.log(e.responseText)}})}}