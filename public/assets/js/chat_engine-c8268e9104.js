console.log("chat_engine.js is loaded");class ChatEngine{constructor(e,s,t,o){console.log(t,"userId"),this.chatBox=$("#"+e),this.userEmail=s,this.userName=o,this.userId=t,this.socket=io.connect("http://localhost:5000"),this.userEmail&&this.connectionHandler()}connectionHandler(){let e=this;this.socket.on("connect",(function(){console.log("connection established using sockets...!",e.userId),e.socket.emit("loggedin",e.userId),$("#user-chat-box").hide()})),e.socket.on("invite",(function(s){console.log("Invitation received to join a room"),console.log("Invition accepted to join the room"),e.socket.emit("joinRoom",s),$(`span[data-room="${s.room.room}"]`).attr("data-room-created","true")})),$("#chat-message-input-container").submit((function(s){s.preventDefault();let t=$("#chat-message-input").val();console.log("After mgs is clicked: ");let o=$("#chat-message-input-container button").attr("data-room");if(""!=t&&"null"!=o){let s=$("#chat-with-friend").val();e.socket.emit("create",{room:o,userId:e.userId,withUserId:s}),$.ajax({type:"post",url:"/chats/create",data:$("#chat-message-input-container").serialize(),success:function(e){console.log("message sent "+e),new Noty({theme:"relax",text:"Message Sent!",type:"success",layout:"topRight",timeout:1500}).show()},error:function(e){console.log(e.responseText)}}),e.socket.emit("send_message",{message:t,user_email:e.userEmail,user_name:e.userName,user_id:e.userId,room:o}),$("#chat-message-input").val("")}})),e.socket.on("receive_message",(function(s){if(console.log("message received",s.message),e.userName!=s.user_name&&$("#chat-box-friend-name").html(s.user_name),$("#chat-message-input-container button").attr("data-room")==s.room){let t=$("<li>"),o="other-message";s.user_email==e.userEmail&&(o="self-message"),t.append($("<span>",{html:s.message})),t.append($("<sub>",{html:s.user_email})),t.addClass(o),$("#chat-messages-list").append(t)}else{$(`span[data-room="${s.room}"] i`).removeClass("remove-new-message-icon"),console.log("class removed")}}))}createRoom(e,s){console.log("createRoom function is called with friendId",e);let t=$(`#chat-${e} span`).attr("data-room-created");console.log("isRoomExist value: ",t,$(`#chat-${e} span`));let o=$(`#chat-${e} span`).attr("data-room");"false"==t?(console.log("Room created successfully by you, room is: ",o),this.socket.emit("create",{room:o,userId:this.userId,withUserId:e}),$(`#chat-${e} span`).attr("data-room-created","true"),this.openChatWindow(o,e,s)):(console.log("Room already exists"),this.openChatWindow(o,e,s)),$(`span[data-room="${o}"] i`).addClass("remove-new-message-icon")}openChatWindow(e,s,t){$("#chat-messages-list").html(""),$("#user-chat-box").show(),$("#chat-message-input-container button").attr("data-room",e),$("#chat-with-friend").val(s),$("#chat-box-friend-name").html(t),console.log("New chat window opened"),this.fillChats(s)}fillChats(e){let s=this;$.ajax({type:"get",url:"/chats",data:{friendId:e},success:function(e){console.log("message received "+e);for(let t of e.data.chats){let e=$("<li>"),o="other-message";t.from_user._id==s.userId&&(o="self-message"),e.append($("<span>",{html:t.message})),e.append($("<sub>",{html:t.from_user.email})),e.addClass(o),$("#chat-messages-list").append(e)}},error:function(e){console.log(e.responseText)}})}}