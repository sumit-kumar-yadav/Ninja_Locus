console.log("chat_engine.js file is loaded !");class ChatEngine{constructor(e,t,s,a){console.log(s,"userId"),this.chatBox=$("#"+e),this.userEmail=t,this.userName=a,this.userId=s,this.timer=null,this.socket=io.connect("http://localhost:5000"),this.userEmail&&this.connectionHandler()}connectionHandler(){let e=this;this.socket.on("connect",(function(){console.log("connection established using sockets...!",e.userId),e.socket.emit("loggedin",e.userId)})),e.socket.on("invite",(function(t){console.log("Invitation received to join a room"),console.log("Invition accepted to join the room"),e.socket.emit("joinRoom",t),$(`span[data-room="${t.room.room}"]`).attr("data-room-created","true")})),$("#chat-message-input-container").submit((async function(t){t.preventDefault();let s=$("#chat-message-input").val();console.log("After mgs is clicked: ");let a=$("#chat-message-input-container button").attr("data-room");""!=s&&"null"!=a&&($.ajax({type:"post",url:"/chats/create",data:$("#chat-message-input-container").serialize(),success:function(e){console.log("message sent "+e),new Noty({theme:"relax",text:"Message Sent!",type:"success",layout:"topRight",timeout:1500}).show()},error:function(e){console.log(e.responseText)}}),e.socket.emit("send_message",{message:s,user_email:e.userEmail,user_name:e.userName,user_id:e.userId,room:a}),$("#chat-message-input").val(""))})),e.socket.on("receive_message",(function(t){if(console.log("message received",t.message),$("#chat-message-input-container button").attr("data-room")==t.room){let s=$("<li>"),a="other-message";t.user_email==e.userEmail?(a="self-message",s.append($(`\n                        <img src='${$("#nav-avatar").attr("src")}' alt="image">\n                    `))):s.append($(`\n                        <img src='${$("#chat-box-friend-avatar img").attr("src")}' alt="img">\n                    `)),s.append($("<span>",{html:t.message})),s.append($("<sub>",{html:t.user_email})),s.addClass(a),$("#chat-messages-list").append(s),document.getElementById("chat-messages-list").scrollBy(0,s.height()+10),e.readMessages(t.room,t.user_id)}else{$(`span[data-room="${t.room}"] i`).removeClass("remove-new-message-icon"),console.log("class removed"),new Noty({theme:"relax",text:"Message from "+t.user_name,type:"success",layout:"topRight",timeout:1500}).show(),new Noty({theme:"relax",text:"Check in Ninjas",type:"success",layout:"topRight",timeout:1500}).show()}}))}createRoom(e,t){console.log("createRoom function is called with friendId",e,event.target);let s=$(`#chat-${e} span`).attr("data-room-created");console.log("isRoomExist value: ",s,$(`#chat-${e} span`));let a=$(`#chat-${e} span`).attr("data-room");"false"==s?(console.log("Room created successfully by you, room is: ",a),this.socket.emit("create",{room:a,userId:this.userId,withUserId:e}),$(`#chat-${e} span`).attr("data-room-created","true"),this.openChatWindow(a,e,t,event.target)):(console.log("Room already exists"),this.openChatWindow(a,e,t,event.target)),$(`span[data-room="${a}"] i`).addClass("remove-new-message-icon")}openChatWindow(e,t,s,a){$("#chat-messages-list").html(""),$("#user-chat-box").show(),$("#chat-message-input-container button").attr("data-room",e),$("#chat-with-friend").val(t),$("#chat-box-friend-name").html(s),console.log("Target element is : ",$(a).attr("data-avatar-url"));let o=$(a).attr("data-avatar-url");o?($("#chat-box-friend-avatar").html(""),$("#chat-box-friend-avatar").append(`\n                <img src="${o}" alt="img" onerror="this.onerror=null;this.src='/images/Users-avatar.png';">\n            `)):($("#chat-box-friend-avatar").html(""),$("#chat-box-friend-avatar").append('\n                <img src="/images/Users-avatar.png" alt="img">\n            ')),console.log("New chat window opened"),window.history.pushState({id:1},null,`?name=${s}&u=extra`),this.fillChats(t),this.readMessages(e,t)}fillChats(e){let t=this;$.ajax({type:"get",url:"/chats",data:{friendId:e},success:function(e){console.log("message received "+e);for(let s of e.data.chats){let e=$("<li>"),a="other-message";s.from_user._id==t.userId&&(a="self-message"),e.append($(`\n                        <img src=${s.from_user.avatar} alt="image" onerror="this.onerror=null;this.src='/images/Users-avatar.png';">\n                    `)),e.append($("<span>",{html:s.message})),e.append($("<sub>",{html:new Date(s.from_user.createdAt).toString().substring(4,16)+"at"+new Date(s.from_user.createdAt).toString().substring(16,21)})),e.addClass(a),$("#chat-messages-list").append(e)}t.scrollToBottom(),$("#chat-loading-animaiton").hide()},error:function(e){console.log(e.responseText)}})}readMessages(e,t){console.log("under readMessages function: ",t),$.ajax({type:"get",url:"/chats/readMessages",data:{friendId:t},success:function(t){if(t.data.read){$(`span[data-room="${e}"] i`).addClass("remove-new-message-icon")}},error:function(e){console.log(error.responseText)}})}scrollToBottom(){let e=document.getElementById("chat-messages-list");e.scrollTop=e.scrollHeight-e.clientHeight}emitToRejoin(){console.log("input changed"),clearTimeout(this.timer),this.timer=setTimeout(()=>{let e=$("#chat-with-friend").val(),t=$("#chat-message-input-container button").attr("data-room");this.socket.emit("create",{room:t,userId:this.userId,withUserId:e}),console.log("Joining req resent")},300)}}function unreadMessages(){console.log("unreadmessages function is called"),$(".friends-of-user span").each((function(){let e=$(this),t=e.attr("data-friendId"),s=e.attr("data-room");$.ajax({type:"get",url:"/chats/checkUnreadMessages",data:{friendId:t},success:function(e){if(console.log("inside unreadMessages",e.data.unread),e.data.unread){$(`span[data-room="${s}"] i`).removeClass("remove-new-message-icon")}else{$(`span[data-room="${s}"] i`).addClass("remove-new-message-icon")}},error:function(e){console.log(error.responseText)}})}))}unreadMessages();